# Optimization

## Introduction

Please [Indexing](AQLIndexingAndScanStrategy.md) and [Explain Plan](AQLExplainPlan.md) before reading this section. This section discusses the techniques used by the AQL engine to change the where clause at runtime such that it can benefit from an index (if not already) or benefit from a better index, thus improving performance without the user having to understand the internals of the [Indexing and Scan Strategies](AQLIndexingAndScanStrategy.md).  

## Available Rule Based Optimizations

There are 4 rule based optimizations that run in the current Rule Based Optimizer in AQL. Note that in some situations, you may have more than one optimization run sequentially. The `explain` plan explain the trace of optimizations run and series of  improvements in index usage.

### Rule Details

| Order | Rule                                                  | Result of Optimization                                                                                                                                                                                                                                                                                                                                                                           | Pre-conditions                                                                                                                                                                                                                                                                                                                     |
| ----- | ----------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1     | ReorderingOptimization (Optimization-1)               | Re-order the conditions in the `where` clause to encourage the use of an index or a better index. For example, change the `where` clause from<br/>`where relation.isWithin(polygon) and relation.hasId(1) and relation.hasTag(aaa: "bbb")`<br/>to,<br/>`where relation.hasId(1) and relation.isWithin(polygon)  and relation.hasTag(aaa: "bbb")`                                                 | IFF, <br/>0. Passes AbstractQueryOptimizationTransform#isApplicable(Explain)<br/> 1. only "and" clauses are used in the "where" clause (i.e. no "or" clauses in "where").<br/> 2. The conditions use different scan types.<br/> 3. A condition using an inferior scan type is placed before a condition with a superior scan type. |
| 2     | IdsInOptimization (Optimization-2)                    | Optimization to overcome the problem with non-use of an index when an `or` clause is used in `where` when the only condition checked are related to `id`.                                                                                                                                                                                                                                        | IFF,<br/>  1. All constraints are based on ID_UNIQUE_INDEX - hasId(anId), hasIds(id1, id2, id3, ...), hasIds(innerSelect) is used<br/>  2. Only or clause is used (no `and` or `not`).                                                                                                                                             |
| 3     | GeometricSurfacesWithinOptimization (Optimization-3)  | Similar to the IdsInOptimization that tries to do away with `or`s in the `where` clause.  But here it applies to polygons. It combines multiple within checks to one to encourage use of the spatial index.                                                                                                                                                                                      | IFF,<br/>1. All constraints are based on SPATIAL_INDEX - isWithin(GeometricSurface)<br/>2. Only or clause is used.                                                                                                                                                                                                                 |
| 4     | GeometricSurfacesOverlapOptimization (Optimization-4) | Removes the polygons with a `within` check that are outside the bounds of the atlas. For example, if your where clause is looking for all airports in Northern and Southern Singapore as well as London (UK), when the atlas is representing Singapore, it is safe say that, you won't find any London airports in Singapore and the polygon is removed from the `where` clause's `within` check. | Whenever the `within` check is present in the `where` clause                                                                                                                                                                                                                                                                      |

## Debugging optimization

Running the `explain` command is the best way to understand if the optimization kicked in and if so, how many optimizations were applied and in what order (the order is fixed). It also "explains" the nature of change in the `where` clause and how an index was used post the optimization


